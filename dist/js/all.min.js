PointMall.controller("AddressAddCtrl",["$scope","$rootScope","Util","AddressSev","selectPCASev",function(a,b,c,d,e){console.log("address add"),a.fm={userName:"",phone:"",baseAddress:"",street:""},a.$on("$ionicView.beforeEnter",function(){console.log("address  before enter..");var d=c.getSgObj("selectAddress");a.fm.baseAddress=d&&d.province&&d.city&&d.area?d.province+" "+d.city+" "+d.area:"",b.scrollTopByName("addressAddScroll")}),a.goSelectAddress=function(){e.check(function(){b.go("mall.select.province")})};var f=function(a){var c=/^[\u4e00-\u9fa5]+$/i;return a.street.length>50?(b.alert("","收获地址过长！小于50个字"),!1):11!=a.phone.length?(b.alert("","请输入正确的手机号码!"),!1):a.userName.length<2||a.userName.length>5?(b.alert("","请输入正确的收货人姓名!"),!1):c.test(a.userName)?!0:(b.alert("","请输入中文!"),!1)};a.addAddress=function(){if(a.isSubmit=!0,!f(a.fm))return void(a.isSubmit=!1);var e=a.fm.baseAddress.split(" "),g=e[0],h=e[1],i=e[2];d.addAddress(b.token,g,h,i,a.fm.street,a.fm.userName,a.fm.phone).then(function(d){if("0000000"==d.rtnCode){b.alert("","地址添加成功");{c.setLgObj("address",d.bizData)}a.resetAdd(),b.go("mall.address.list")}else alert(d.msg)},function(){})},a.resetAdd=function(){c.removeSg("selectAddress"),a.fm={};var d=c.getLgObj("address");d?b.backToView("mall.address.list"):b.back()}}]),PointMall.controller("AddressListCtrl",["$scope","$rootScope","Util","MallSev",function(a,b,c,d){var e,f;a.$on("$ionicView.beforeEnter",function(){b.scrollTopByName("addressListScroll"),console.log("address list  before enter.."),e=c.getSgObj("product"),f=c.getLgObj("address"),a.posts=f,a.fm={currentAddress:f[0].id}}),a.exchange=function(){var c;"1"==e.productionType&&(c=a.fm.currentAddress),d.exchange(b.token,e.productionId,e.productionType,c).then(function(a){"0000000"==a.rtnCode?(b.alert("","兑换成功"),b.go("mall.exchange")):b.alert("",a.msg)},function(){})}}]),PointMall.controller("MallExchangeDetailCtrl",["$scope","$rootScope","$timeout","$stateParams","Util","MallSev",function(a,b,c,d,e,f){a.post={},console.log("Mall exchange  detail...");var g=d.exchangeId;a.goShop=function(a){alert("请在pc或手机浏览器内 兑换 ")};var h=function(){f.getExchangeDetail(b.token,g).then(function(b){a.post=b.bizData},function(a){})};a.goDetail=function(a){b.loading(!0),f.getProductDetail(a.exchangeLog.productionId).then(function(a){b.loading(!1),"0000000"==a.rtnCode?(e.setSgObj("product",a.bizData),b.go("mall.detail")):alert(a.msg)},function(a){b.loading(!1)})},h()}]),PointMall.controller("MallExchangeCtrl",["$scope","$ionicScrollDelegate","$rootScope","$timeout","$stateParams","Util","MallSev",function(a,b,c,d,e,f,g){a.posts=[],a.isNotProduct=!1,a.canInfiniteScroll=!1,a.fm={queryTime:0},a.isSubmit=!1,a.isMore=!0,a.isTime=[],a.loadMore=function(){console.log("load more..."),h(c.token,a.fm.queryTime).then(function(b){console.log("load...data"),"0000000"==b.rtnCode?b.bizData.length<=0?a.isMore=!1:(a.posts=a.posts.concat(b.bizData),a.fm.queryTime=b.bizData[b.bizData.length-1].createDate,a.$broadcast("scroll.infiniteScrollComplete")):console.error("error")},function(a){})};var h=function(a,b){return g.getExchange(a,b)};a.refresh=function(){console.log("refresh..."),a.fm.queryTime=0,d(function(){h(c.token,a.fm.queryTime).then(function(b){a.$broadcast("scroll.refreshComplete"),"0000000"==b.rtnCode?0==b.bizData?a.isNotProduct=!0:(a.fm.queryTime=b.bizData[b.bizData.length-1].createDate,a.posts=b.bizData,a.isMore=!0):alert(b.msg)},function(b){a.$broadcast("scroll.refreshComplete")})},0)},a.getDetail=function(a){c.go("mall.exchange.detail",{exchangeId:a.id})},a.refresh()}]),PointMall.controller("MallDetailCtrl",["$state","$stateParams","$scope","$rootScope","Util","AddressSev","MallSev","PROTOCOL",function(a,b,c,d,e,f,g,h){var i=e.getSgObj("product");console.log(i.comment),i.comment=JSON.parse(i.comment),c.post=i,c.notExchange=!0,c.isExchangeMsg="不足兑换",i.status==h.product.status.no_start?(c.notExchange=!0,c.isExchangeMsg="未开始"):i.status==h.product.status.finish?(c.notExchange=!0,c.isExchangeMsg="已结束"):d.user.credit-i.credit>=0&&(c.notExchange=!1,c.isExchangeMsg="兑换"),c.goPage=function(){switch(i.productionType){case 1:j();break;case 2:alert("自取");break;case 3:l();break;case 4:k();break;default:alert("无")}};var j=function(){e.getLgObj("address");d.loading(!0),f.getAddress(d.token).then(function(a){d.loading(!1),a.bizData.length>0?(e.setLgObj("address",a.bizData),d.go("mall.address.list")):(e.removeLg("address"),d.go("mall.address.add"))},function(){d.loading(!1)})},k=function(){d.go("mall.virtual.input")},l=function(){var b="";d.loading(!0),g.exchange(d.token,i.productionId,i.productionType,b).then(function(b){d.loading(!1),"0000000"==b.rtnCode?(b.bizData.productionName=i.productionName,e.setSgObj("volume",b.bizData),a.go("mall.volume")):d.alert("",b.msg)},function(){d.loading(!1)})}}]),PointMall.controller("MallListCtrl",["$state","$rootScope","$scope","Util","MallSev",function(a,b,c,d,e){c.posts=[],c.fm={queryTime:0},c.getItemHeight=function(a,b){return b%2===0?50:60},c.loadList=function(){e.getProduct(b.token,c.fm.queryTime).then(function(a){console.log(a),"0000000"==a.rtnCode?c.posts=a.bizData:alert(a.msg)},function(a){})},c.goDetail=function(b){d.setSgObj("product",b),a.go("mall.detail")},c.loadList()}]),PointMall.controller("MallCtrl",["$state","$stateParams","$location","$scope","$timeout","$rootScope","$ionicLoading","$ionicScrollDelegate","$ionicPopup","Util","MallSev",function(a,b,c,d,e,f,g,h,i,j,k){var l;l=-1==c.$$absUrl.indexOf("#")?c.$$absUrl.substring(c.$$absUrl.indexOf("?")+1,c.$$absUrl.length):c.$$absUrl.substring(c.$$absUrl.indexOf("?")+1,c.$$absUrl.indexOf("#")),l=j.parseParams(l);var m=j.getParam("token",l);if(!m)return void alert("token为空!");f.isLoadingVal=!1,f.token=m,console.log(f.token),f.MOBILE={version:j.getParam("version",l)||"",clientType:j.getParam("clientType",l)||""},f.IS_IOS=ionic.Platform.isIOS(),console.log(f.MOBILE),f.user={credit:""},f.token||alert("token失效"),f.backToView=function(a){j.backToView(a)},f.go=function(b,c){c=c||{},a.go(b,c)},f.alert=function(a,b){i.alert({title:a||"",template:b,okText:"确定"})},f.scrollTopByName=function(a){h.$getByHandle(a).scrollTop()};var n=document.body.clientWidth,o=750/301;d.bannerHeight=n/o,f.getUser=function(a){f.isLoadingVal=!0,k.getUserCreadit(a).then(function(a){f.isLoadingVal=!1,f.user.credit=a.bizData.credit},function(a){f.isLoadingVal=!1})},f.getUser(f.token),f.goCicadaVal=function(){"iOS"==f.MOBILE.clientType?window.location="cicada://cicadaStore/gotoActiveValue":window.cicadaStore.gotoActiveValue()},f.goCicadaBack=function(){"iOS"==f.MOBILE.clientType?window.location="cicada://cicadaStore/back":window.cicadaStore.back()},f.loading=function(a){a?g.show():g.hide()},f.back=function(a){j.back()}}]);var SelectPCA=angular.module("selectPCA",[]).controller("SelectProvinceCtrl",["$scope","$rootScope","$timeout","Util","selectPCASev","GeoLocationSev",function(a,b,c,d,e,f){console.log("province controller only one ..."),a.fm={geoAddress:""},a.isGeoLoading=!0,f.LBS().then(function(a){var b=a.coords.longitude,c=a.coords.latitude;return console.log(b,c),f.geocoder(c,b)},function(c){console.log(c),b.alert("",c.msg),a.isGeoLoading=!1}).then(function(c){if(c.rtnCode&&"0000000"==c.rtnCode){var d=JSON.parse(c.bizData.addressJson).result.addressComponent;a.fm.geoAddress=d.province+" "+d.city+" "+d.district}else c.rtnCode&&b.alert("",c.msg);a.isGeoLoading=!1},function(){a.isGeoLoading=!1}),a.posts=[],a.selectLBS=function(){if(""!=a.fm.geoAddress){var c=a.fm.geoAddress.split(" ");d.setSgObj("selectAddress",{province:c[0],city:c[1],area:c[2]}),b.backToView("mall.address.add")}};var g=function(){e.getProvinceList().then(function(b){console.log("走了一遍省"),a.posts=b})};a.goCity=function(a){d.setSgObj("selectAddress",{province:a.name}),b.go("mall.select.city",{code:a.code})},g()}]).controller("SelectCityCtrl",["$scope","$stateParams","$rootScope","Util","selectPCASev",function(a,b,c,d,e){console.log("city controller only one ...");var f=b.code;a.posts=[],e.getCityByProvince(f).then(function(b){console.log("走了一遍市"),a.posts=b}),a.goArea=function(a){var b=d.getSgObj("selectAddress");b.city=a.name,d.setSgObj("selectAddress",b),c.go("mall.select.area",{code:a.code})}}]).controller("SelectAreaCtrl",["$scope","$stateParams","$rootScope","Util","selectPCASev",function(a,b,c,d,e){console.log("area controller only one ..."),a.posts=[];var f=b.code;e.getAreaByCity(f).then(function(b){console.log("走了一遍区"),a.posts=b}),a.finish=function(a){var b=d.getSgObj("selectAddress");b.area=a.name,d.setSgObj("selectAddress",b),c.go("mall.address.add")}}]);PointMall.controller("VirtualInputCtrl",["$state","$rootScope","$ionicPopup","$scope","Util","MallSev",function(a,b,c,d,e,f){var g=e.getSgObj("product");d.fm={phone:"",productionId:g.productionId},d.isSubmit=!1,console.log("input..."),d.showConfirm=function(a,b){},d.exchange=function(){function e(a){var b=/^0?(13[0-9]|15[012356789]|18[0123456789]|14[57])[0-9]{8}$/;return b.exec(a)?!0:!1}if(console.log(g.productName),!e(d.fm.phone))return void b.alert("","请输入正确的手机号!");var h=c.confirm({title:"提示",template:"确认给号码"+d.fm.phone+"兑换"+g.productionName+"?",buttons:[{text:"取消",type:"button-default"},{text:"确定",type:"button-positive",onTap:function(a){return"success"}}]});h.then(function(c){c&&(d.isSubmit=!0,f.exchange(b.token,d.fm.productionId,g.productionType,d.fm.phone).then(function(c){console.log(c),"0000000"==c.rtnCode?(b.alert("","兑换成功!"),b.getUser(b.token),a.go("mall.exchange")):b.alert("",c.msg),d.isSubmit=!1},function(a){d.isSubmit=!1}))})}}]),PointMall.controller("VolumeExchange",["$state","$state","$ionicPopup","$scope","Util","MallSev",function(a,b,c,d,e,f){}]),PointMall.controller("VolumeInputCtrl",["$state","$rootScope","$ionicPopup","$scope","Util","MallSev",function(a,b,c,d,e,f){var g=e.getSgObj("volume");d.post=g,d.goShop=function(a){alert("请在pc或手机浏览器内 兑换 ")}}]),SelectPCA.factory("GeoLocationSev",["$http","$q","SERVER",function(a,b,c){navigator.geolocation||alert("您的浏览器不支持使用HTML 5来获取地理位置服务");var d=function(a){var b;switch(a.code){case 1:b="位置服务被拒绝";break;case 2:b="暂时获取不到位置信息";break;case 3:b="获取信息超时";break;case 4:b="未知错误"}var c={code:a.code,msg:b};return c};return{LBS:function(){console.log("开始定位");var a=b.defer();return navigator.geolocation.getCurrentPosition(function(b){a.resolve(b)},function(b){a.reject(d(b))},{enableHighAccuracy:!0,maximumAge:1e3}),a.promise},geocoder:function(d,e){var f=b.defer();return a.post(c.url.mall+"/address/getAddressByLatAndLong",{style:"",clientInfo:{},data:{latitude:d,longitude:e}}).success(function(a){f.resolve(a)}).error(function(a){f.reject(a)}),f.promise}}}]),PointMall.factory("MallSev",["$http","$q","SERVER",function(a,b,c){var d={getProduct:function(d,e){var f=b.defer();return a.post(c.url.mall+"/credit/getProductionList",{style:"",clientInfo:{},data:{token:d,queryTime:e}}).success(function(a){f.resolve(a)}).error(function(a){f.reject(a)}),f.promise},getProductDetail:function(d){var e=b.defer();return a.post(c.url.mall+"/credit/queryProductionDetailById",{style:"",clientInfo:{},data:{productionId:d}}).success(function(a){e.resolve(a)}).error(function(a){e.reject(a)},{timeout:18e3}),e.promise},exchange:function(d,e,f,g){var h=b.defer();return a.post(c.url.mall+"/credit/exchangeProduction",{style:"",clientInfo:{},data:{token:d,productionId:e,productionType:f,comment:g}}).success(function(a){h.resolve(a)}).error(function(a){h.reject(a)}),h.promise},getExchange:function(d,e){var f=b.defer();return a.post(c.url.mall+"/credit/queryExchangeProductionListByUserId",{style:"",clientInfo:{},data:{token:d,queryTime:e}}).success(function(a){f.resolve(a)}).error(function(a){f.reject(a)}),f.promise},getExchangeDetail:function(d,e){e=parseInt(e);var f=b.defer();return a.post(c.url.mall+"/credit/queryExchangeDetailById",{style:"",clientInfo:{},data:{token:d,exchangeId:e}}).success(function(a){f.resolve(a)}).error(function(a){f.reject(a)}),f.promise},getUserCreadit:function(d){var e=b.defer();return a.post(c.url.mall+"/credit/getUserCreditByUserId",{style:"",clientInfo:{},data:{token:d}}).success(function(a){e.resolve(a)}).error(function(a){e.reject(a)}),e.promise}};return d}]).factory("AddressSev",["$http","$q","SERVER",function(a,b,c){var d={getAddress:function(d){var e=b.defer();return a.post(c.url.mall+"/address/getAddresses",{style:"",clientInfo:{},data:{token:d}}).success(function(a){e.resolve(a)}).error(function(a){e.reject(a)}),e.promise},addAddress:function(d,e,f,g,h,i,j){var k=b.defer();return a.post(c.url.mall+"/address/insertAddress",{style:"",clientInfo:{},data:{token:d,provice:e,city:f,district:g,street:h,userName:i,phone:j}}).success(function(a){k.resolve(a)}).error(function(a){k.reject(a)}),k.promise}};return d}]).filter("exchangeStatus",["$http","$q","SERVER",function(){return function(a,b){return b&&1==b?0==a?"配送中":"已完成":b&&4==b?0==a?"充值中":"已完成":b&&3==b?"兑换成功":void 0}}]),SelectPCA.constant("PCA_SQL",{CREATE:{TABLE:{PROVINCE:"create table if not exists cicada_province (id INTEGER PRIMARY KEY,code INTEGER,name TEXT)",CITY:"create table if not exists cicada_city (id INTEGER PRIMARY KEY  ,code INTEGER,name TEXT,province INTEGER  )",AREA:"create table if not exists cicada_area (id INTEGER PRIMARY KEY ,code INTEGER,name TEXT,city INTEGER  )"}},SELECT:{ALL_PROVINCE:"select * from cicada_province",CITY:"select * from cicada_city as c where c.province=?",AREA:"select * from cicada_area as a where a.city=?"},DROP:{TABLE:{PROVINCE:"drop table cicada_province",CITY:"drop table cicada_city",AREA:"drop table cicada_area"}}}),SelectPCA.factory("AddressDataSourceSev",["$http","$q","SERVER",function(a,b,c){return{getProvince:function(){var d=b.defer();return a.get(c.url.resource+"/sql/p.sql").success(function(a){a=a.split(";"),d.resolve(a)}).error(function(a){d.reject()}),d.promise},getCity:function(){var d=b.defer();return a.get(c.url.resource+"/sql/c.sql").success(function(a){a=a.split(";"),d.resolve(a)}).error(function(a){d.reject()}),d.promise},getArea:function(){var d=b.defer();return a.get(c.url.resource+"/sql/a.sql").success(function(a){a=a.split(";"),d.resolve(a)}).error(function(a){d.reject()}),d.promise}}}]),SelectPCA.factory("selectPCASev",["$q","$rootScope","PCA_SQL","Util","VERSION","AddressDataSourceSev",function(a,b,c,d,e,f){var g=function(){};g.prototype.check=function(a){var c=d.getLgObj("addressDataBase");try{this.db=window.openDatabase("cicadaStore","2.0","cicadaStore",2097152),console.log("2.0 database")}catch(f){this.db=window.openDatabase("cicadaStore","1.0","cicadaStore",2097152),b.loading(!1)}c&&c.version==e.ADDRESS_SOURCE_VERSION?(console.log("地址已经缓存.."),a()):(d.loading(!0),this.init(a))},g.prototype.init=function(a){j(this.db),h(this.db),i(this.db,a)},g.prototype.open=function(){this.db=window.openDatabase("cicadaStore","2.0","cicadaStore",2097152)},g.prototype.getProvinceList=function(){return d.selectSql(this.db,c.SELECT.ALL_PROVINCE)},g.prototype.getCityByProvince=function(a){return d.selectSql(this.db,c.SELECT.CITY,[a])},g.prototype.getAreaByCity=function(a){return d.selectSql(this.db,c.SELECT.AREA,[a])};var h=function(a){a.transaction(function(a){a.executeSql(c.CREATE.TABLE.PROVINCE,[],function(a,b){console.log("创建province表成功",b)},function(a,b){console.log("创建province表失败:"+b.message)}),a.executeSql(c.CREATE.TABLE.CITY,[],function(a,b){console.log("创建CITY表成功",b)},function(a,b){console.log("创建CITY表失败:"+b.message)}),a.executeSql(c.CREATE.TABLE.AREA,[],function(a,b){console.log("创建AREA表成功",b)},function(a,b){console.log("创建AREA表失败:"+b.message)})})},i=function(b,c){a.all({f1:f.getProvince(),f2:f.getCity(),f3:f.getArea()}).then(function(a){b.transaction(function(b){for(var f=a.f1.concat(a.f2).concat(a.f3),g=0,h=3239,i=function(){g++,g>=h&&(d.setLgObj("addressDataBase",{isUpdate:"1",version:e.ADDRESS_SOURCE_VERSION}),c(),d.loading(!1),console.log("创建完成"))},j=function(a,b){d.loading(!1),console.log(a)},k=0;k<f.length;k++){var l=f[k];l&&b.executeSql(l,[],i,j)}})},function(a){d.loading(!1),console.log(a)})},j=function(a){a.transaction(function(a){a.executeSql(c.DROP.TABLE.PROVINCE,[]),a.executeSql(c.DROP.TABLE.CITY,[]),a.executeSql(c.DROP.TABLE.AREA,[])})},k=new g;return k}]),PointMall.factory("Util",["$window","$q","$ionicLoading","$ionicHistory",function(a,b,c,d){return{getSgObj:function(b){var c=a.sessionStorage.getItem(b);return JSON.parse(c)},setSgObj:function(b,c){return a.sessionStorage.setItem(b,JSON.stringify(c))},getSg:function(b){return a.sessionStorage.getItem(b)},setSg:function(b,c){a.sessionStorage.setItem(b,c)},remove:function(b){a.sessionStorage.removeItem(b)},removeSg:function(b){a.sessionStorage.removeItem(b)},loading:function(a){a?c.show():c.hide()},getLgObj:function(b){var c=a.localStorage.getItem(b);return JSON.parse(c)},setLgObj:function(b,c){return a.localStorage.setItem(b,JSON.stringify(c))},getLg:function(b){return a.localStorage.getItem(b)},setLg:function(b,c){a.localStorage.setItem(b,c)},removeLg:function(b){a.localStorage.removeItem(b)},executeSql:function(a,c,d){var e=b.defer();return d=d||[],a.transaction(function(a){a.executeSql(c,d,function(a,b){e.resolve(b)},function(a,b){console.log(b),e.reject(b)})}),e.promise},selectSql:function(a,c,d){var e=b.defer();return a.transaction(function(a){a.executeSql(c,d,function(a,b){for(var c=[],d=0;d<b.rows.length;d++)c.push(b.rows.item(d));e.resolve(c)},function(a,b){console.log(b),e.reject(b)})}),e.promise},backToView:function(a){for(var b=d.currentHistoryId(),c=d.viewHistory().histories[b],e=c.stack.length-1;e>=0;e--)c.stack[e].stateName==a&&(d.backView(c.stack[e]),d.goBack())},back:function(){d.goBack()},parseParams:function(a){for(var b=a.split("&"),c=[],d=0;d<b.length;d++){var e=b[d].split("="),f='{"'+e[0]+'": "'+e[1]+'" }',g=JSON.parse(f);c.push(g)}return c},getParam:function(a,b){for(var c=0;c<b.length;c++){var d=b[c];if(d[a])return d[a]}return""}}}]),PointMall.directive("imgLazy",function(){var a=document.body.clientWidth;return{restrict:"AE",transclude:!0,template:'<div class="pos-rel inherit"><div ng-transclude></div><div class="baseMap"></div></div>',scope:{},link:function(b,c,d){var e,f=d.auto;console.log(a),f?(console.log(a/f),e=a/f+"px"):e=d.height,c.find("img").css("height",e),c.css({width:d.width,height:e})}}}),PointMall.directive("spinner",function(){return{restrict:"E",template:"<div></div>",scope:{type:"@"},link:function(a,b,c){var d='<svg version="1.1" id="loading-svg"  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"  viewBox="0 0 64 64"> <g fill="none" fill-rule="evenodd" stroke-width="3"><circle cx="32" cy="32" r="9.42876"><animate attributeName="r" begin="0s" dur="2s" values="0;24" keyTimes="0;1" keySplines="0.1,0.2,0.3,1" calcMode="spline" repeatCount="indefinite"></animate><animate attributeName="stroke-opacity" begin="0s" dur="2s" values=".2;1;.2;0" repeatCount="indefinite"></animate></circle><circle cx="32" cy="32" r="22.335"><animate attributeName="r" begin="-1s" dur="2s" values="0;24" keyTimes="0;1" keySplines="0.1,0.2,0.3,1" calcMode="spline" repeatCount="indefinite"></animate><animate attributeName="stroke-opacity" begin="-1s" dur="2s" values=".2;1;.2;0" repeatCount="indefinite"></animate></circle></g> </svg>';"ripple"==a.type&&b.html(d)}}}),PointMall.factory("AjaxInterceptors",["$window","$q","SERVER","$rootScope",function(a,b,c,d){return{request:function(a){return a},response:function(a){return a},responseError:function(a){var c=b.defer(),e={};switch(a.status){case 500:e.content="An error occurred on the server";break;case 401:e.content="You are not logged in";break;case 403:e.content="You do not have permission to perform this operation";break;case 404:e.content="Did not find the resources";break;case 408:e.content="The request timeout";break;default:e.content="Network error"}return e.type="danger",e.title="error",e.status=a.status,d.httpError=e,c.reject(a.status),c.promise}}}]);